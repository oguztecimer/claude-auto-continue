---
phase: 01-detection-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - vitest.config.ts
  - src/config.ts
  - test/config.test.ts
autonomous: true
requirements:
  - DETC-05
must_haves:
  truths:
    - "npm install completes without errors and all dependencies are available"
    - "TypeScript compiles with strict mode and CommonJS output"
    - "vitest runs and discovers test files in test/ directory"
    - "loadConfig() returns default empty config when no config file exists"
    - "loadConfig() parses a valid config file and returns a RegExp from a string pattern"
    - "loadConfig() returns empty config on invalid JSON or missing file without throwing"
  artifacts:
    - path: "package.json"
      provides: "Project definition with strip-ansi@6, vitest, typescript, tsx dependencies"
      contains: "strip-ansi"
    - path: "tsconfig.json"
      provides: "TypeScript configuration targeting CommonJS output"
      contains: "commonjs"
    - path: "vitest.config.ts"
      provides: "Vitest configuration for test discovery"
    - path: "src/config.ts"
      provides: "Config file loader from ~/.config/claude-auto-continue/config.json"
      exports: ["loadConfig", "ToolConfig"]
    - path: "test/config.test.ts"
      provides: "Unit tests for config loader"
  key_links:
    - from: "src/config.ts"
      to: "~/.config/claude-auto-continue/config.json"
      via: "fs.readFileSync with os.homedir()"
      pattern: "readFileSync.*config\\.json"
    - from: "test/config.test.ts"
      to: "src/config.ts"
      via: "import { loadConfig }"
      pattern: "import.*loadConfig.*config"
---

<objective>
Initialize the project with TypeScript, vitest, and strip-ansi dependencies, then build the config loader module that reads detection patterns from `~/.config/claude-auto-continue/config.json`.

Purpose: Establishes the build toolchain and the config loading foundation that PatternDetector depends on. Without this, no TypeScript code compiles and no tests run.
Output: Working project with `npm test` running, plus a tested `loadConfig()` function.
</objective>

<execution_context>
@/Users/dakmor/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dakmor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-detection-engine/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize project with TypeScript, vitest, and strip-ansi</name>
  <files>package.json, tsconfig.json, vitest.config.ts</files>
  <action>
Create the project foundation:

1. **package.json** — Initialize with `npm init -y`, then set:
   - `name`: `claude-auto-continue`
   - `version`: `0.1.0`
   - `type`: Do NOT set `"type": "module"` — this is a CommonJS project
   - `scripts.test`: `vitest run`
   - `scripts.test:watch`: `vitest`
   - `scripts.build`: `tsc`

2. **Install dependencies:**
   ```bash
   npm install strip-ansi@6
   npm install -D typescript@5 vitest@2 @types/node tsx
   ```
   Use strip-ansi@6 specifically — v7 is ESM-only and incompatible with this CJS project. Do NOT use v7.

3. **tsconfig.json** — Create with these settings:
   ```json
   {
     "compilerOptions": {
       "target": "ES2022",
       "module": "commonjs",
       "moduleResolution": "node",
       "outDir": "dist",
       "rootDir": "src",
       "strict": true,
       "esModuleInterop": true,
       "skipLibCheck": true,
       "declaration": true,
       "sourceMap": true
     },
     "include": ["src"],
     "exclude": ["node_modules", "dist", "test"]
   }
   ```

4. **vitest.config.ts** — Create:
   ```typescript
   import { defineConfig } from 'vitest/config';

   export default defineConfig({
     test: {
       globals: true,
       include: ['test/**/*.test.ts'],
     },
   });
   ```

5. Create empty `src/` and `test/` directories.

6. Verify: `npx tsc --noEmit` succeeds (no source files yet, should be clean). `npx vitest run` exits cleanly (no tests yet).
  </action>
  <verify>
    <automated>npm install && npx tsc --noEmit && npx vitest run 2>&1 | tail -5</automated>
  </verify>
  <done>package.json has all dependencies, tsconfig.json targets CJS with strict mode, vitest discovers test/ directory, all three commands exit without error</done>
</task>

<task type="auto">
  <name>Task 2: Create config loader with unit tests</name>
  <files>src/config.ts, test/config.test.ts</files>
  <action>
Create the config loading module per RESEARCH.md Pattern 3 and locked user decisions.

1. **src/config.ts** — Implement `loadConfig()`:
   - Read `~/.config/claude-auto-continue/config.json` synchronously using `fs.readFileSync`
   - Use `path.join(os.homedir(), '.config', 'claude-auto-continue', 'config.json')` for cross-platform path — do NOT hardcode `/Users/...`
   - Export `ToolConfig` interface: `{ pattern?: RegExp }`
   - Export `CONFIG_PATH` constant (for testability)
   - If file exists and contains valid JSON with a `pattern` string field, convert it to `RegExp` with case-insensitive flag
   - On ANY error (file not found, invalid JSON, invalid regex string), return empty object `{}` — NEVER throw
   - This function is called once at PatternDetector construction time

   ```typescript
   import { readFileSync } from 'fs';
   import { homedir } from 'os';
   import { join } from 'path';

   export interface ToolConfig {
     pattern?: RegExp;
   }

   export const CONFIG_PATH = join(homedir(), '.config', 'claude-auto-continue', 'config.json');

   export function loadConfig(): ToolConfig {
     try {
       const raw = readFileSync(CONFIG_PATH, 'utf8');
       const parsed = JSON.parse(raw);
       const config: ToolConfig = {};
       if (typeof parsed.pattern === 'string') {
         config.pattern = new RegExp(parsed.pattern, 'i');
       }
       return config;
     } catch {
       return {};
     }
   }
   ```

2. **test/config.test.ts** — Write tests that mock the filesystem:
   - Test: returns empty config when file does not exist
   - Test: returns RegExp from valid JSON with pattern string
   - Test: returns empty config on invalid JSON
   - Test: returns empty config when pattern field is not a string (e.g., number)
   - Test: config path uses os.homedir() (assert CONFIG_PATH contains homedir)

   Use `vi.mock('fs')` to mock `readFileSync` — do NOT create actual config files on disk. Import `CONFIG_PATH` to verify path construction.

3. Run tests: `npx vitest run test/config.test.ts`
  </action>
  <verify>
    <automated>npx vitest run test/config.test.ts</automated>
  </verify>
  <done>loadConfig() returns ToolConfig with parsed RegExp from valid config, returns {} on missing/invalid file without throwing, CONFIG_PATH uses os.homedir(), all tests pass</done>
</task>

</tasks>

<verification>
1. `npm install` completes without errors
2. `npx tsc --noEmit` compiles cleanly
3. `npx vitest run` — all config tests pass
4. Config loader never throws on any error condition
</verification>

<success_criteria>
- Project compiles with TypeScript strict mode
- vitest discovers and runs tests
- strip-ansi@6 is installed (not v7)
- loadConfig() works correctly for all cases: missing file, valid file, invalid file
- CONFIG_PATH is cross-platform via os.homedir()
</success_criteria>

<output>
After completion, create `.planning/phases/01-detection-engine/01-01-SUMMARY.md`
</output>
