---
phase: 03-single-session-status-display
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/CountdownCard.ts
  - test/CountdownCard.test.ts
autonomous: true
requirements: [RESM-03]

must_haves:
  truths:
    - CountdownCard.render() produces a centered box with session name, countdown, and reset time
    - Box is horizontally centered within the given terminal width
    - Box is vertically centered within the given terminal height (minus status bar row)
    - Countdown string updates correctly when called with different times
    - Empty/null resetTime shows "Unknown" instead of crashing
  artifacts:
    - src/CountdownCard.ts
    - test/CountdownCard.test.ts
  key_links:
    - CountdownCard imports formatCountdown and formatResetTime from StatusBar
    - CountdownCard imports ANSI helpers from ansi.ts
---

<objective>
Build the centered CountdownCard renderer using TDD.

Purpose: When the session is in WAITING state, a large centered countdown card replaces the normal scroll area content, showing session name, live countdown to reset, and absolute reset time. This gives clear visual feedback that the tool is alive and counting down.

Output: `src/CountdownCard.ts` (countdown card renderer) and its test file.
</objective>

<execution_context>
@/Users/dakmor/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dakmor/.claude/get-shit-done/templates/summary.md
@/Users/dakmor/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-single-session-status-display/03-RESEARCH.md

<interfaces>
<!-- Imports needed from Plan 01 artifacts (same wave, no file overlap) -->

From src/ansi.ts (being built in Plan 01, same wave — no dependency conflict since files don't overlap):
```typescript
export function moveTo(row: number, col: number): string;
export const clearLine: string;
export function bold(text: string): string;
export function yellow(text: string): string;
```

From src/StatusBar.ts (being built in Plan 01):
```typescript
export function formatCountdown(resetTime: Date): string;
export function formatResetTime(resetTime: Date): string;
```

NOTE: Since Plan 01 and Plan 02 are in the same wave but touch different files, the executor should implement CountdownCard assuming these imports exist. If Plan 01 hasn't completed yet, mock the imports in tests using vi.mock(). The integration will work once both plans are complete.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD CountdownCard — centered countdown display</name>
  <files>src/CountdownCard.ts, test/CountdownCard.test.ts</files>
  <action>
RED-GREEN-REFACTOR cycle for CountdownCard class.

Create `test/CountdownCard.test.ts` first. CountdownCard is a pure renderer — it produces strings, no I/O.

**CountdownCard class design:**

```typescript
interface CountdownCardOptions {
  cols?: number;   // terminal width, default 80
  rows?: number;   // terminal height, default 24
}

class CountdownCard {
  constructor(options?: CountdownCardOptions);

  /** Render the full countdown card as an ANSI string. Does NOT write to terminal. */
  render(opts: { resetTime: Date | null; cwd: string }): string;

  /** Clear the card area (restore scroll region content) */
  clear(): string;
}
```

**Tests to write:**

1. `render({ resetTime: futureDate, cwd: '/home/user/project' })` output contains the cwd path
2. Output contains a countdown string (from formatCountdown)
3. Output contains the absolute reset time (from formatResetTime)
4. Output contains "Waiting for rate limit reset" or similar header text
5. Box is centered: first moveTo row is approximately (rows/2 - cardHeight/2), adjusted for status bar
6. Box lines are centered: each line starts at approximately (cols/2 - boxWidth/2)
7. Box has border characters (e.g., `+--+` top/bottom, `|  |` sides — or unicode box drawing)
8. `render({ resetTime: null, cwd: '/path' })` shows "Unknown" for countdown and reset time instead of crashing
9. Card width adapts: with cols=40, box is narrower than with cols=120
10. `clear()` produces escape sequences that clear the card area (moveTo + clearLine for each row the card occupied)

**Mock strategy for imports from Plan 01:** Since ansi.ts and StatusBar.ts may not exist yet during parallel execution, mock them in tests:

```typescript
vi.mock('../src/ansi.js', () => ({
  moveTo: (r: number, c: number) => `[MOVE:${r},${c}]`,
  clearLine: '[CLEAR]',
  bold: (t: string) => `[BOLD:${t}]`,
  yellow: (t: string) => `[YELLOW:${t}]`,
}));
```

Then implement `src/CountdownCard.ts`:
- Import moveTo, clearLine, bold, yellow from `./ansi.js`
- Import formatCountdown, formatResetTime from `./StatusBar.js`
- Card layout (approximately 7 lines tall, 40-50 chars wide):
  ```
  +----------------------------------------------+
  |                                              |
  |         Waiting for rate limit reset         |
  |                                              |
  |              3m 22s remaining                |
  |           Resets at 2:45 PM                  |
  |                                              |
  |         Session: /path/to/project            |
  |                                              |
  +----------------------------------------------+
  ```
- Center the box both horizontally and vertically (accounting for row 1 being the status bar)
- Use moveTo() to position each line of the box
- bold() for the header, yellow() for the countdown number
- If resetTime is null, show "Unknown" for countdown and "Unknown" for reset time
  </action>
  <verify>
    <automated>npx vitest run test/CountdownCard.test.ts</automated>
  </verify>
  <done>All CountdownCard tests pass. Card renders correctly centered with countdown, reset time, and session path. Handles null resetTime gracefully. Pure string output with no I/O.</done>
</task>

</tasks>

<verification>
- `npx vitest run test/CountdownCard.test.ts` — all tests pass
- CountdownCard produces correctly centered box layout
- null resetTime does not crash
- No process.stdout.write calls in CountdownCard
</verification>

<success_criteria>
- CountdownCard renders a centered box with countdown, reset time, and session name
- Box is horizontally and vertically centered for given terminal dimensions
- Handles null resetTime gracefully
- Zero I/O side effects (pure string renderer)
</success_criteria>

<output>
After completion, create `.planning/phases/03-single-session-status-display/03-02-SUMMARY.md`
</output>
