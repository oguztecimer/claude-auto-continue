---
phase: 03-single-session-status-display
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/ansi.ts
  - src/StatusBar.ts
  - test/ansi.test.ts
  - test/StatusBar.test.ts
autonomous: true
requirements: [RESM-03]

must_haves:
  truths:
    - StatusBar.render() produces ANSI escape sequences that position content at row 1
    - Color helper green() wraps text in SGR 32m/0m codes
    - Color helper yellow() wraps text in SGR 33m/0m codes
    - Color helper red() wraps text in SGR 31m/0m codes
    - setScrollRegion(top, bottom) produces correct DECSTBM sequence
    - StatusBar.update() changes displayed state text and re-renders
    - formatCountdown() converts a future Date to "Xm YYs" string
    - formatResetTime() converts a Date to human-readable time (e.g., "2:45 PM")
  artifacts:
    - src/ansi.ts
    - src/StatusBar.ts
    - test/ansi.test.ts
    - test/StatusBar.test.ts
  key_links:
    - StatusBar imports from ansi.ts for escape sequences and colors
---

<objective>
Build the StatusBar renderer and ANSI escape code helpers using TDD.

Purpose: Create the foundational display layer that renders a fixed top-row status bar with color-coded session state, countdown timer, and working directory. All rendering is pure string computation (no I/O side effects), making it fully unit-testable.

Output: `src/ansi.ts` (ANSI escape helpers), `src/StatusBar.ts` (status bar renderer), and their test files.
</objective>

<execution_context>
@/Users/dakmor/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dakmor/.claude/get-shit-done/templates/summary.md
@/Users/dakmor/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-single-session-status-display/03-RESEARCH.md

<interfaces>
<!-- Key types and contracts from existing codebase -->

From src/ProcessSupervisor.ts:
```typescript
export const enum SessionState {
  RUNNING = 'RUNNING',
  LIMIT_DETECTED = 'LIMIT_DETECTED',
  WAITING = 'WAITING',
  RESUMING = 'RESUMING',
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD ansi.ts — ANSI escape code helpers</name>
  <files>src/ansi.ts, test/ansi.test.ts</files>
  <action>
RED-GREEN-REFACTOR cycle for a pure-function ANSI escape code helper module.

Create `test/ansi.test.ts` first with tests for:
- `moveTo(row, col)` returns `\x1b[{row};{col}H`
- `saveCursor` is `\x1b7`
- `restoreCursor` is `\x1b8`
- `setScrollRegion(top, bottom)` returns `\x1b[{top};{bottom}r`
- `resetScrollRegion` is `\x1b[r`
- `clearLine` is `\x1b[2K`
- `green(text)` returns `\x1b[32m{text}\x1b[0m`
- `yellow(text)` returns `\x1b[33m{text}\x1b[0m`
- `red(text)` returns `\x1b[31m{text}\x1b[0m`
- `bold(text)` returns `\x1b[1m{text}\x1b[0m`
- `inverse(text)` returns `\x1b[7m{text}\x1b[0m`
- `showCursor` is `\x1b[?25h`
- `hideCursor` is `\x1b[?25l`
- `resetAttributes` is `\x1b[0m`

Then create `src/ansi.ts` implementing all helpers. These are simple string-returning functions — no I/O, no dependencies.

Export as named exports (CJS-compatible). Use `const` for string constants and plain functions for parameterized ones.
  </action>
  <verify>
    <automated>npx vitest run test/ansi.test.ts</automated>
  </verify>
  <done>All ANSI helper tests pass. Module exports all escape code functions. Zero dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: TDD StatusBar — fixed top-row status bar renderer</name>
  <files>src/StatusBar.ts, test/StatusBar.test.ts</files>
  <action>
RED-GREEN-REFACTOR cycle for StatusBar class.

Create `test/StatusBar.test.ts` first. StatusBar is a pure renderer — it produces strings, doesn't write to stdout directly. Tests validate string output.

**StatusBar class design:**

```typescript
interface StatusBarOptions {
  cols?: number;  // terminal width, default 80
}

class StatusBar {
  constructor(options?: StatusBarOptions);

  /** Render the status bar content string for the current state. Does NOT write to terminal. */
  render(state: string, opts?: { resetTime?: Date; cwd?: string }): string;

  /** Produce the ANSI sequence to initialize scroll region (rows 2..termRows) */
  initScrollRegion(rows: number): string;

  /** Produce the ANSI cleanup sequence (reset scroll region, show cursor, reset attrs) */
  cleanup(): string;
}
```

**Tests to write:**
1. `render('RUNNING')` includes green-colored "Running" text
2. `render('WAITING', { resetTime })` includes yellow-colored "Waiting" text AND countdown string AND absolute reset time
3. `render('RESUMING')` includes green-colored "Resuming" text
4. `render('DEAD')` includes red-colored "Dead" text (note: DEAD is not in the enum but the display needs it)
5. Rendered output starts with saveCursor + moveTo(1,1) + clearLine
6. Rendered output ends with restoreCursor
7. Output is padded/truncated to `cols` width
8. `initScrollRegion(24)` returns setScrollRegion(2, 24) + moveTo(2, 1)
9. `cleanup()` returns resetScrollRegion + showCursor + resetAttributes
10. `formatCountdown(resetTime)` — when resetTime is 65 seconds from now, returns "1m 05s"
11. `formatCountdown(resetTime)` — when resetTime is 3661 seconds from now, returns "1h 01m 01s"
12. `formatResetTime(date)` — returns formatted time like "2:45 PM"

Export `formatCountdown` and `formatResetTime` as named exports (used by CountdownCard in Plan 02).

Then implement `src/StatusBar.ts`:
- Import helpers from `./ansi.js`
- StatusBar.render() builds the status bar string using ANSI helpers
- Status text format: `" [State] | [countdown if waiting] | [cwd] "`
- For RUNNING: `" Running | /path/to/cwd "`  (green state)
- For WAITING: `" Waiting | 3m 22s (resets 2:45 PM) | /path/to/cwd "`  (yellow state)
- For RESUMING: `" Resuming... | /path/to/cwd "`  (green state)
- For DEAD: `" Dead | /path/to/cwd "`  (red state)
- Use inverse video for the entire bar (white text on colored background)
- formatCountdown: calculate from resetTime - Date.now(), format as Xh Xm Xs
- formatResetTime: use toLocaleTimeString with hour:'numeric', minute:'2-digit'
  </action>
  <verify>
    <automated>npx vitest run test/StatusBar.test.ts</automated>
  </verify>
  <done>All StatusBar tests pass. StatusBar produces correct ANSI strings for all four states. formatCountdown and formatResetTime are exported and tested. No I/O side effects in the class itself.</done>
</task>

</tasks>

<verification>
- `npx vitest run test/ansi.test.ts test/StatusBar.test.ts` — all tests pass
- ansi.ts has zero dependencies
- StatusBar.ts depends only on ansi.ts
- No process.stdout.write calls in StatusBar (pure renderer)
</verification>

<success_criteria>
- All ANSI escape helpers tested and working
- StatusBar renders correct strings for RUNNING, WAITING, RESUMING, DEAD states
- Countdown formatting produces human-readable time strings
- Reset time formatting shows absolute time
- Zero I/O side effects in production code (pure string functions)
</success_criteria>

<output>
After completion, create `.planning/phases/03-single-session-status-display/03-01-SUMMARY.md`
</output>
